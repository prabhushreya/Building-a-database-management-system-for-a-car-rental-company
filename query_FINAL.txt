--QUERY 1

COLUMN MAKE FORMAT A12
COLUMN MODEL FORMAT A15
COLUMN LICENSENO FORMAT A10
COLUMN OUTNO FORMAT A5

SELECT R.RENTALNO, TO_CHAR(STARTDATE,'MM/DD/YYYY HH24:MI:SS') AS STARTDATETIME, 
NVL(TO_CHAR(RETURNDATE,'MM/DD/YYYY HH24:MI:SS'),'NOT RETURNED') AS RETURNDATETIME,
MILEAGEBEFORE, MILEAGEAFTER, V.LICENSENO, MAKE, MODEL, TO_CHAR(OUTNO) AS OUTNO, YEAR,
NVL(TO_CHAR(DATECHECKED,'MM/DD/YYYY HH24:MI:SS'),'NO FAULt REPORT') AS DATECHECKED
FROM RAGREEMENT R JOIN VEHICLE V ON R.LICENSENO = V.LICENSENO
                  LEFT OUTER JOIN FAULTREPORT F ON F.RENTALNO = R.RENTALNO;
					

--QUERY 2
COLUMN OUTLET_NO FORMAT A15
COLUMN AVG_DIST_DRIVEN_PERRENTAL FORMAT 99999
	
SELECT TO_CHAR(A.OUTNO) AS OUTLET_NO, A.NO_VEHICLES, NVL(B.NO_RENTALS,0) AS NO_RENTALS_LASTYEAR, 
NVL(B.AVG_DIST_DRIVEN_PERRENTAL,0) AS AVGDISTANCE_PERRENTAL_LASTYEAR, A.NO_EMPLOYEES, 
NVL(ROUND((B.NO_RENTALS/A.NO_EMPLOYEES),2),0) AS NO_RENTALS_PEREMP_LASTYEAR
FROM
	(
	SELECT OUTNO, COUNT(DISTINCT LICENSENO) AS NO_VEHICLES, COUNT(DISTINCT EMPNO) AS NO_EMPLOYEES
	FROM VEHICLE JOIN OUTLET USING(OUTNO)
				 JOIN EMPLOYEE USING(OUTNO)
	GROUP BY OUTNO
	) A
	LEFT OUTER JOIN
	(
	SELECT OUTNO, COUNT(DISTINCT RENTALNO) AS NO_RENTALS,
	ROUND(AVG(MILEAGEAFTER-MILEAGEBEFORE),2) AS AVG_DIST_DRIVEN_PERRENTAL
	FROM RAGREEMENT JOIN VEHICLE USING(LICENSENO)
					JOIN OUTLET USING(OUTNO)
					JOIN EMPLOYEE USING(OUTNO)
	WHERE MONTHS_BETWEEN(SYSDATE, STARTDATE)<= 12
	GROUP BY OUTNO
	) B 
	ON A.OUTNO = B.OUTNO
UNION
SELECT 'GRAND TOTAL', A.NO_VEHICLES, NVL(B.NO_RENTALS,0), NVL(B.AVG_DIST_DRIVEN_PERRENTAL,0), A.NO_EMPLOYEES, 
NVL(ROUND((B.NO_RENTALS/A.NO_EMPLOYEES),2),0) AS NO_RENTALS_PER_EMPLOYEE
FROM
	(
	SELECT OUTNO, COUNT(DISTINCT LICENSENO) AS NO_VEHICLES, COUNT(DISTINCT EMPNO) AS NO_EMPLOYEES
	FROM VEHICLE JOIN OUTLET USING(OUTNO)
				 JOIN EMPLOYEE USING(OUTNO)
	) A,
    (
	SELECT COUNT(DISTINCT RENTALNO) AS NO_RENTALS,
	ROUND(AVG(MILEAGEAFTER-MILEAGEBEFORE),2) AS AVG_DIST_DRIVEN_PERRENTAL
	FROM RAGREEMENT JOIN VEHICLE USING(LICENSENO)
					JOIN OUTLET USING(OUTNO)
					JOIN EMPLOYEE USING(OUTNO)
	WHERE MONTHS_BETWEEN(SYSDATE, STARTDATE)<= 12
	) B 
ORDER BY 1;
	
	
--QUERY 3


COLUMN MONTH FORMAT A12
COLUMN TOTAL_REVENUE_MONTH FORMAT A20
COLUMN REVENUE_PERRENTAL_MONTH FORMAT A25
COLUMN NO_RENTALS_MONTH FORMAT A18


SELECT NVL(TO_CHAR(B.MONTH_OF_YEAR),'GRAND TOTAL') AS MONTH,
TO_CHAR(SUM(DECODE(OUTNO,101,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET1,
TO_CHAR(SUM(DECODE(OUTNO,102,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET2,
TO_CHAR(SUM(DECODE(OUTNO,103,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET3,
TO_CHAR(SUM(DECODE(OUTNO,104,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET4,
TO_CHAR(SUM(DECODE(OUTNO,105,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET5,
TO_CHAR(SUM(DECODE(OUTNO,106,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET6,
TO_CHAR(SUM(DECODE(OUTNO,107,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET7,
TO_CHAR(SUM(DECODE(OUTNO,108,DAILYRATE*CEIL(RETURNDATE-STARTDATE),0)),'9990.99') AS OUTLET8,
TO_CHAR(NVL(ROUND(SUM(DAILYRATE*(RETURNDATE-STARTDATE)),2),0),'9990.99') AS TOTAL_REVENUE_MONTH,
TO_CHAR(NVL(COUNT(RENTALNO),0)) AS NO_RENTALS_MONTH, 
TO_CHAR(NVL(ROUND(SUM(DAILYRATE*CEIL(RETURNDATE-STARTDATE))/COUNT(RENTALNO), 2),0),'9990.99') AS REVENUE_PERRENTAL_MONTH
FROM
	(
	SELECT EXTRACT(MONTH FROM R.RETURNDATE) AS MONTH,V.OUTNO,R.RETURNDATE,R.STARTDATE,V.DAILYRATE,RENTALNO
	FROM VEHICLE V JOIN RAGREEMENT R ON V.LICENSENO = R.LICENSENO
	WHERE (EXTRACT(YEAR FROM SYSDATE)) - 1 = EXTRACT(YEAR FROM R.RETURNDATE)
	) A
	RIGHT OUTER JOIN 
	(
	SELECT ROWNUM  AS MONTH_OF_YEAR
	FROM DUAL 
	CONNECT BY ROWNUM < = 12
	) B 
	ON A.MONTH = B.MONTH_OF_YEAR
GROUP BY ROLLUP(B.MONTH_OF_YEAR);

	
--QUERY 4
--R REPRESENTSB NO. OF RENTALS
--F REPRESENTS NO. OF FAULT REPORTS
COLUMN "OUTLET_TOTALS(R,F)" FORMAT A20
COLUMN OUTLET_NO FORMAT A15
COLUMN "MON(R,F)" FORMAT A10
COLUMN "TUE(R,F)" FORMAT A10
COLUMN "WED(R,F)" FORMAT A10
COLUMN "THU(R,F)" FORMAT A10
COLUMN "FRI(R,F)" FORMAT A10
COLUMN "SAT(R,F)" FORMAT A10
COLUMN "SUN(R,F)" FORMAT A10

SELECT NVL(TO_CHAR(V.OUTNO), 'WEEKDAY TOTALS') AS OUTLET_NO,
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'MON',1,0))||','|| SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'MON',1,0)) AS "MON(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'TUE',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'TUE',1,0)) AS "TUE(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'WED',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'WED',1,0)) AS "WED(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'THU',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'THU',1,0)) AS "THU(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'FRI',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'FRI',1,0)) AS "FRI(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'SAT',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'SAT',1,0)) AS "SAT(R,F)",
SUM(DECODE(TO_CHAR(R.STARTDATE, 'DY'), 'SUN',1,0)) || ',' || SUM(DECODE(TO_CHAR(F.DATECHECKED, 'DY'), 'SUN',1,0)) AS "SUN(R,F)",
TO_CHAR(COUNT(R.RENTALNO)||',' ||COUNT(F.REPORTNUM)) AS "OUTLET_TOTALS(R,F)"
FROM VEHICLE V LEFT OUTER JOIN RAGREEMENT R ON V.LICENSENO = R.LICENSENO
			   LEFT OUTER JOIN FAULTREPORT F ON R.RENTALNO = F.RENTALNO 
WHERE SYSDATE - R.STARTDATE < 180
GROUP BY ROLLUP(V.OUTNO)
UNION
SELECT TO_CHAR(OUTNO),
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'MON', 0,0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'MON', 0,0)) AS "MON(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'TUE', 0,0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'TUE', 0,0)) AS "TUE(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'WED', 0, 0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'WED', 0, 0)) AS "WED(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'THU',0, 0)) || ' '  || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'THU',0, 0))AS "THU(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'),  'FRI', 0, 0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'),  'FRI', 0, 0)) AS "FRI(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'SAT', 0, 0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'SAT', 0, 0)) AS "SAT(R,F)",
SUM(DECODE(TO_CHAR (STARTDATE, 'DY'), 'SUN', 0, 0)) || ' ' || SUM(DECODE(TO_CHAR (DateChecked, 'DY'), 'SUN', 0, 0)) AS "SUN(R,F)",
SUM(0)||','||SUM(0)
FROM VEHICLE V LEFT OUTER JOIN RAGREEMENT R ON V.LICENSENO = R.LICENSENO
			   LEFT OUTER JOIN FAULTREPORT F ON R.RENTALNO = F.RENTALNO
WHERE OUTNO NOT IN  (
				    SELECT OUTNO
					FROM OUTLET JOIN VEHICLE USING(OUTNO) 
								JOIN RAGREEMENT USING (LICENSENO) 
					WHERE SYSDATE - STARTDATE < 180
					)
GROUP BY V.OUTNO
ORDER BY 1;
				
--QUERY 5
COLUMN MANAGER_INFO FORMAT A25
COLUMN OUTLET_NO FORMAT A10
SELECT NVL(O.MANAGERNO||' : '||E.FNAME||' '||E.LNAME,'GRAND TOTAL') AS MANAGER_INFO, TO_CHAR(O.OUTNO) AS OUTLET_NO, COUNT(R.RENTALNO) AS NO_RENTALS, 
ROUND((SUM(V.DAILYRATE* CEIL(R.RETURNDATE - R.STARTDATE))/COUNT(R.RENTALNO)),2) AS AVG_REVENUE_PERRENTAL, 
ROUND(COUNT(F.LICENSENO)/ COUNT(R.RENTALNO),2) AS AVG_FAULTREP_PERRENTAL
FROM
OUTLET O JOIN EMPLOYEE E ON O.MANAGERNO = E.EMPNO
		 JOIN VEHICLE V ON O.OUTNO = V.OUTNO
		 JOIN RAGREEMENT R ON V.LICENSENO = R.LICENSENO
		 LEFT OUTER JOIN FAULTREPORT F ON F.RENTALNO = R.RENTALNO
GROUP BY ROLLUP(O.MANAGERNO||' : '||E.FNAME||' '||E.LNAME, O.OUTNO);
	
--QUERY 6
	
SELECT TO_CHAR(OUTNO) AS OUTLET, A.REVENUE
FROM (	
		SELECT MAX(REVENUE) AS REVENUE
		FROM(
			SELECT  OUTNO, SUM(DAILYRATE*CEIL(RETURNDATE - STARTDATE)) AS REVENUE
			FROM RAGREEMENT RA
				JOIN VEHICLE V ON RA.LICENSENO = V.LICENSENO
			WHERE TO_CHAR(RETURNDATE, 'Q')= 4 AND EXTRACT(YEAR FROM RETURNDATE) = (EXTRACT(YEAR FROM SYSDATE) - 1) 
				  OR
				  TO_CHAR(RETURNDATE, 'Q') = 1 AND EXTRACT(YEAR FROM RETURNDATE) = EXTRACT(YEAR FROM SYSDATE) 		
		GROUP BY OUTNO))A
	JOIN (
		SELECT OUTNO, SUM(DAILYRATE*CEIL(RETURNDATE - STARTDATE)) AS REVENUE
			FROM RAGREEMENT RA
				JOIN VEHICLE V ON RA.LICENSENO = V.LICENSENO
			WHERE TO_CHAR(RETURNDATE, 'Q')= 4 AND EXTRACT(YEAR FROM RETURNDATE) = (EXTRACT(YEAR FROM SYSDATE) - 1) 
				  OR
				  TO_CHAR(RETURNDATE, 'Q') = 1 AND EXTRACT(YEAR FROM RETURNDATE) = EXTRACT(YEAR FROM SYSDATE) 	
		GROUP BY OUTNO)MAX ON A.REVENUE = MAX.REVENUE
UNION
SELECT TO_CHAR(OUTNO), B.REVENUE
FROM (
		SELECT MIN(REVENUE) AS REVENUE
		FROM(
			SELECT  OUTNO, SUM(DAILYRATE*CEIL(RETURNDATE - STARTDATE)) AS REVENUE
			FROM RAGREEMENT RA
				JOIN VEHICLE V ON RA.LICENSENO = V.LICENSENO
			WHERE TO_CHAR(RETURNDATE, 'Q')= 4 AND EXTRACT(YEAR FROM RETURNDATE) = (EXTRACT(YEAR FROM SYSDATE) - 1) 
				  OR
				  TO_CHAR(RETURNDATE, 'Q') = 1 AND EXTRACT(YEAR FROM RETURNDATE) = EXTRACT(YEAR FROM SYSDATE) 	
		GROUP BY OUTNO))B
	JOIN (
		SELECT OUTNO, SUM(DAILYRATE*CEIL(RETURNDATE - STARTDATE)) AS REVENUE
			FROM RAGREEMENT RA
				JOIN VEHICLE V ON RA.LICENSENO = V.LICENSENO
			WHERE TO_CHAR(RETURNDATE, 'Q')= 4 AND EXTRACT(YEAR FROM RETURNDATE) = (EXTRACT(YEAR FROM SYSDATE) - 1) 
				  OR
				  TO_CHAR(RETURNDATE, 'Q') = 1 AND EXTRACT(YEAR FROM RETURNDATE) = EXTRACT(YEAR FROM SYSDATE) 	
		GROUP BY OUTNO)MIN ON B.REVENUE = MIN.REVENUE;


--QUERY 7

COLUMN MAKE FORMAT A15
COLUMN MODEL FORMAT A15
COLUMN NO_CARS FORMAT A7
COLUMN AVERAGE_AGE_CAR FORMAT A15
COLUMN NO_RENTALS_THISYEAR FORMAT A15
COLUMN NODAYS_CAR_RENTED_THISYEAR FORMAT A15
COLUMN NODAYS_CAR_RENTED_THISYEAR FORMAT A15
COLUMN NO_FAULTREPORTS_THISYEAR FORMAT A15


SELECT NVL(V.MAKE, '[GRAND TOTAL]') AS MAKE, 
	   V.MODEL, TO_CHAR(COUNT(DISTINCT V.LICENSENO)) AS NO_CARS, 
	   TO_CHAR(ROUND(AVG(EXTRACT(YEAR FROM SYSDATE)-V.YEAR),2)) AS AVERAGE_AGE_CAR,
	   TO_CHAR(COUNT(R.RENTALNO)) AS NO_RENTALS_THISYEAR, 
	   TO_CHAR(NVL(CEIL(SUM(R.RETURNDATE - R.STARTDATE)),0))AS NODAYS_CAR_RENTED_THISYEAR, 
	   TO_CHAR(COUNT(F.LICENSENO)) AS NO_FAULTREPORTS_THISYEAR
FROM VEHICLE V 
LEFT OUTER JOIN RAGREEMENT R ON V.LICENSENO = R.LICENSENO AND EXTRACT(YEAR FROM R.RETURNDATE) = EXTRACT(YEAR FROM SYSDATE)
LEFT OUTER JOIN FAULTREPORT F ON F.RENTALNO = R.RENTALNO 
GROUP BY ROLLUP(V.MAKE, V.MODEL)
ORDER BY MAKE, MODEL;



--QUERY 8

COLUMN MAKE FORMAT A25
BREAK BY QUARTER

SELECT 'Q'||A.QUARTER QUARTER, 
		A.MAKE, 
		NVL(FAULTS/RENTALS, 0) AS "CHANCE_OF_FAULTS", 
		NVL(RENTALS, 0) "NUMBER",
DENSE_RANK() OVER (PARTITION BY A.QUARTER ORDER BY(NVL(FAULTS/RENTALS, 0)) DESC) AS RANK
FROM 
	(SELECT DISTINCT QUARTER, MAKE
	FROM 
		(SELECT MAKE 
		FROM VEHICLE)
	CROSS JOIN 
		(SELECT TO_CHAR(LEVEL) QUARTER 
				FROM DUAL
				CONNECT BY LEVEL < = 4))A
LEFT JOIN 
	(SELECT MAKE, 
		NVL(TO_CHAR(FR.DATECHECKED, 'Q'), 'VEHICLE NOT RETURNED') THIS_QUARTER, 
		COUNT(REPORTNUM) AS "FAULTS"
		FROM FAULTREPORT FR
			JOIN VEHICLE V ON FR.LICENSENO = V.LICENSENO AND EXTRACT(YEAR FROM DATECHECKED) = 2017 
		GROUP BY (MAKE, TO_CHAR(FR.DATECHECKED, 'Q'))
		ORDER BY THIS_QUARTER)B ON A.MAKE = B.MAKE AND A.QUARTER = B.THIS_QUARTER
LEFT JOIN 
	(SELECT MAKE, 
			NVL(TO_CHAR(RA.RETURNDATE, 'Q'), 'VEHICLE NOT RETURNED') THIS_QUARTER, 
			COUNT(RA.RENTALNO) AS "RENTALS" 
		FROM VEHICLE V 
			JOIN RAGREEMENT RA ON RA.LICENSENO = V.LICENSENO AND EXTRACT(YEAR FROM RETURNDATE) = 2017 
		GROUP BY (MAKE, TO_CHAR(RA.RETURNDATE, 'Q'))
		ORDER BY THIS_QUARTER)C ON A.MAKE = C.MAKE AND A.QUARTER = C.THIS_QUARTER
		;







--QUERY 9
COLUMN OUTLET FORMAT A10

SELECT TO_CHAR(B.OUTNO) OUTLET, 
	   NVL(CLIENT_COUNT, 0) NUMBER_OF_CLIENTS, 
	   NVL(A.RENTAL_COUNT, 0) NUMBER_OF_RENTALS, 
	   NVL(CAST(ROUND(A.CLIENT_COUNT/B.TOTAL_CLIENT_COUNT, 2) AS DECIMAL(18,2)), 0.00) AS PROPORTION_CUSTOMERS, 
	   NVL(CAST(ROUND(A.RENTAL_COUNT/B.TOTAL_RENTAL_COUNT, 2) AS DECIMAL(18,2)), 0.00) AS PROPORTION_RENTAL
FROM
	(SELECT O.OUTNO, 
			COUNT(DISTINCT C.CLIENTNO) AS CLIENT_COUNT, 
			COUNT(R.RENTALNO) AS RENTAL_COUNT
	FROM OUTLET O JOIN VEHICLE V ON O.OUTNO = V.OUTNO
			  JOIN RAGREEMENT R ON R.LICENSENO = V.LICENSENO
			  JOIN CLIENT C ON C.CLIENTNO = R.CLIENTNO AND O.STATE = C.STATE			  
	GROUP BY O.OUTNO) A
RIGHT OUTER JOIN
	(SELECT O.OUTNO, 
			COUNT(C.CLIENTNO) AS TOTAL_CLIENT_COUNT, 
			COUNT(R.RENTALNO) AS TOTAL_RENTAL_COUNT
	 FROM OUTLET O JOIN VEHICLE V ON O.OUTNO = V.OUTNO
			  JOIN RAGREEMENT R ON R.LICENSENO = V.LICENSENO
			  JOIN CLIENT C ON C.CLIENTNO = R.CLIENTNO
	GROUP BY O.OUTNO) B ON A.OUTNO = B.OUTNO;

--QUERY 10
COLUMN EMPLOYEE FORMAT A30
COLUMN STREET FORMAT A27
COLUMN REPORTS_IN_LAST90DAYS FORMAT A30
COLUMN OUTNO FORMAT A5

SELECT LEVEL, LPAD(' ', 3*(LEVEL-1))  || E.EMPNO || ':' || E.FNAME ||' ' || E.LNAME AS EMPLOYEE, 
		E.POSITION, 
		TO_CHAR(E.OUTNO) AS OUTNO, 
		O.STREET, 
		TO_CHAR(NVL(NO_REPORTS,0)) AS REPORTS_IN_LAST90DAYS
FROM EMPLOYEE E JOIN OUTLET O ON E.OUTNO = O.OUTNO 
				LEFT OUTER JOIN (SELECT EMPNO, 
										COUNT(REPORTNUM) AS NO_REPORTS
								 FROM FAULTREPORT F 
								 WHERE F.DATECHECKED > (SYSDATE - 90)
								 GROUP BY EMPNO) A ON E.EMPNO = A.EMPNO
START WITH E.EMPNO IN (SELECT EMPNO 
						FROM EMPLOYEE 
						WHERE E.SUPERVISORNO IS NULL)
CONNECT BY PRIOR E.EMPNO = E.SUPERVISORNO;
		


